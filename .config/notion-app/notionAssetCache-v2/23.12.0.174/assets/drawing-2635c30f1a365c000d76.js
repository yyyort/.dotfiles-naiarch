"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[6991],{85529:(t,e,n)=>{n.r(e),n.d(e,{TldrawAdapter:()=>Ft});var o=n(97464),r=n.n(o),i=n(77094),s=n.n(i),a=n(92962),d=n(1369),l=n(51315),c=n(20394),u=n(96486),p=n.n(u),h=n(67294),g=n(480),m=n(24405),f=n(88108),b=n(97880);const w=n(85).bjK,v={serialize:t=>JSON.stringify(t),deserialize:t=>JSON.parse(t)};function*y(t){for(const[e,n]of(0,b.objectEntries)(t.added))yield[e,[void 0,n]];for(const[e,n]of(0,b.objectEntries)(t.updated))yield[e,n];for(const[e,n]of(0,b.objectEntries)(t.removed))yield[e,[n,void 0]]}class _{constructor(){this.added={},this.removed=new Set}static fromSerializedSnapshot(t){const e=new _;return e.mergeSnapshot(t),e}add(t){this.added[t.id]=t,this.removed.delete(t.id)}remove(t){delete this.added[t],this.removed.add(t)}ignore(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(const o of e)delete this.added[o],this.removed.delete(o)}mergeSnapshot(t){for(const[e,n]of(0,b.objectEntries)(t))n?this.add(v.deserialize(n)):this.remove(e)}hasChanges(){return this.removed.size>0||Object.keys(this.added).length>0}}class S{constructor(){this[w]=[]}getPendingIds(){if(0===this[w].length)return new Set;this[w].length>1&&(this[w]=[this.clear()]);const[t]=this[w],e=new Set;for(const[n]of y(t))e.add(n);return e}add(t){this[w].push(t)}clear(){const t=(0,c.bs)(this[w]);return this[w]=[],t}}var x=n(7406),k=n(4615),I=n(63143),M=n(5366),z=n(47307),E=n(9953),C=n(12359),F=n(8848),j=n(82990);const K=n(85).Je3,D=n(85).GmX,P=n(85).lWm,N=n(85).KS0,V=n(85).ewQ,R=n(85)._Fe,Z=n(85).qKK,A=n(85).j$c,O=n(85).FoV,$=n(85).EEp,T=n(85).PKt,H=n(85).HB2,L=n(85).VOR,U=(n(85).hoq,n(85).HYM),B=n(85).lHF;function X(){window.__c={n:"NotionTldrawTheme"};const t=(0,m.Fg)(),e=(0,h.useMemo)((()=>{const e="3px",n=F.ZP[Z](1),o="dark"===t.mode;return{"--color-text":t[R],"--color-text-0":t[R],"--color-text-1":t[R],"--color-text-2":t.mediumTextColor,"--color-text-3":t.lightTextColor,"--color-accent":t[V].red[800],"--color-focus":F.ZP[Z](.14),[T]:n,[H]:F.ZP[Z](.025),[B]:N,"--color-brush-fill":F.ZP[Z](.14),"--color-muted-2":t[P],"--color-selected":n,[L]:t[D],"--color-text-selection":F.ZP[Z](.28),"--color-primary":t.blueButtonBackground,"--color-warn":F.ZP.red,"--radius-0":e,"--radius-1":e,"--radius-2":e,"--radius-3":e,"--radius-4":e,"--color-low":t[K],"--opacity-low":.93,"--radius-5":"6px","--color-panel":t[K],[U]:N,"--color-divider":t.regularDividerColor,"--shadow-2":t.mediumBoxShadow,"--color-background":t[D],"--palette-black":t[V].gray[900],"--palette-blue":o?t[V].blue[800]:t[V].blue[500],"--palette-green":o?t[V].green[800]:t[V].green[500],"--palette-grey":o?t[V].gray[700]:t[V].gray[300],[$]:o?t[V].blue[500]:t[V].blue[200],[O]:o?t[V].green[500]:t[V].green[300],"--palette-red":o?t[V].red[800]:t[V].red[500],"--palette-light-red":o?t[V].red[500]:t[V].red[300],"--palette-violet":o?t[V].purple[800]:t[V].purple[500],[A]:o?t[V].purple[500]:t[V].purple[300],"--palette-orange":o?t[V].orange[700]:t[V].orange[500],"--palette-yellow":o?t[V].yellow[800]:t[V].yellow[500],"--palette-white":t[D]}}),[t]),n=(0,h.useMemo)((()=>{let t=".rs-container {";for(const[n,o]of Object.entries(e))void 0!==o&&(t+=`\n  ${n}: ${o};`);return t+="\n}",t+=`\n\t\t.tlui-button {\n\t\t\ttext-shadow: none;\n\t\t}\n\n\t\t.tlui-slider__range {\n\t\t\tbackground: var(--color-selection-stroke);\n\t\t}\n\n\t\t/* Try to make menu items look like Notion menu items */\n\t\t.tlui-menu__button {\n\t\t\theight: 28px;\n\t\t\tline-height: 150%;\n\t\t\tfont-size: ${j.Z.fontSize.UIRegular.desktop}px;\n\t\t\tpadding: 0 12px;\n\t\t}\n\n\t\t.tlui-menu__checkbox-item {\n\t\t\tpadding-left: 28px;\n\t\t}\n\n\t\t.tlui-menu__checkbox-item__check .tlui-icon__small {\n\t\t\twidth: 18px;\n\t\t\theight: 18px;\n\t\t}\n\n\t\t.tlui-menu__button::after {\n\t\t\twidth: calc(100% - 8px);\n\t\t\theight: 100%;\n\t\t\tleft: 4px;\n\t\t\tright: 4px;\n\t\t\tbottom: 0;\n\t\t\ttop: 0;\n\t\t}\n\n\t\t.tlui-menu__button:nth-child(n + 2) {\n\t\t\tmargin-top: 0;\n\t\t}\n\n\t\t.tlui-menu__button:nth-last-child(n + 2) {\n\t\t\tmargin-bottom: 0;\n\t\t}\n\n\t\t.tlui-menu__group {\n\t\t\tpadding: 4px 0;\n\t\t}\n\n\t\t.tlui-menu__group[data-size='medium'] {\n\t\t\tmin-width: 200px;\n\t\t}\n\n\t\t/* Styling for how keyboard shortcuts are rendered next to menu items */\n\t\t.tlui-kbd {\n\t\t\tfont-size: ${j.Z.fontSize.UISmall.desktop}px;\n\t\t\tcolor: var(--color-text-3);\n\t\t\tdisplay: flex;\n\t\t\tgap: 0;\n\t\t}\n\n\t\t.tlui-kbd > span {\n\t\t\tpadding: 0;\n\t\t\tmargin: 0;\n\t\t}\n\n\t\t.tlui-kbd span + span::before {\n\t\t\tcontent: '+';\n\t\t}\n\n\t\t.rs-error-boundary__content .rs-error-boundary__refresh {\n\t\t\tcolor: var(--color-background);\n\t\t}\n\n\t\t/* Styling for the Tools panel */\n\t\t.tlui-toolbar__tools {\n\t\t\tborder-radius: 999px;\n\t\t\tpadding: 0 8px;\n\t\t}\n\n\t\t.tlui-button {\n\t\t\t--color-selected: transparent;\n\t\t\t--color-selected-contrast: var(--color-selection-stroke);\n\t\t}\n\n\t\t.tlui-button:not(:disabled):hover::after {\n\t\t\tbackground: var(--color-muted-2);\n\t\t}\n\n\t\t/* Styling for "low" toolbars like the top bar and zoom */\n\t\t.tlui-menu-zone::before,\n\t\t.tlui-navigation-zone,\n\t\t.tlui-navigation-zone::before,\n\t\t.tlui-debug-panel {\n\t\t\tborder: none;\n\t\t\tborder-radius: var(--radius-5);\n\t\t\topacity: var(--opacity-low);\n\t\t}\n\n\t\t.tlui-menu-zone::before,\n\t\t.tlui-navigation-zone::before,\n\t\t.tlui-debug-panel\n\t\t{\n\t\t\tinset: 0;\n\t\t\tbox-shadow: var(--shadow-1);\n\t\t}\n\n\t\t.tlui-help-menu__button {\n\t\t\tdisplay: none;\n\t\t}\n\t\t.tlui-help-menu__button::before  {\n\t\t\tbox-shadow: var(--shadow-1);\n\t\t\topacity: var(--opacity-low);\n\t\t}\n\n\t\t/* Styling for extra-small width controls */\n\t\t.tlui-toolbar__extras__controls {\n\t\t\tmargin-left: 20px;\n\t\t}\n\n\t\t.tlui-toolbar__extras__controls,\n\t\t.tlui-toolbar__extras__controls::before\n\t\t{\n\t\t\tborder: none;\n\t\t\tborder-radius: 12px;\n\t\t\tborder-bottom-left-radius: 0px;\n\t\t\tborder-bottom-right-radius: 0px;\n\t\t}\n\n\n\t\t.tlui-toolbar__extras__controls::before {\n\t\t\tinset: 0;\n\t\t\tbox-shadow: var(--shadow-1);\n\t\t}\n\n\t\t/* Make dialogs fit */\n\t\t.tlui-dialog__content {\n\t\t\tmax-height: 80%;\n\t\t}\n\n\t\t/* Hide the "Page" menu */\n\t\t.tlui-popover:has(.tlui-page-menu__trigger) {\n\t\t\tdisplay: none;\n\t\t}\n\n\t\t.tlui-popover:has(.tlui-page-menu__trigger) + .tlui-menu-zone__divider {\n\t\t\tdisplay: none;\n\t\t}\n\n\t\t/* Disable spurious text selection */\n\t\t.rs-container input, *[contenteditable] .rs-container, *[contenteditable] .rs-container * {\n\t\t\tuser-select: none;\n\t\t\t-webkit-user-select: none;\n\t\t}\n\n\t\t/* Style text selection inside text components */\n\t\t.rs-text-input::selection {\n\t\t\tbackground: var(--color-text-selection);\n\t\t\tcolor: currentColor;\n\t\t\ttext-shadow: none;\n\t\t}\n\t\t`,{__html:t}}),[e]);return s()("style",{dangerouslySetInnerHTML:n})}var q=n(87333),W=n(81954),G=n(44615),J=n(19889),Y=n(36054),Q=n(74487),tt=n(41641),et=n(2688),nt=n(39098);const ot=n(85).bjK,rt=n(85).hDW;const it=3*I.MinuteMs,st=1*I.SecondMs,at=Q.literal(0),dt=Q.record(Q.string(),Q.union([at,Q.string()])),lt=Q.record(Q.string(),Q.union([at,dt]));function ct(t){const{[rt]:e,app:n}=t,o=(0,g.O7)(),r=(0,M.useIntl)(),i=e.userId,s=e.id,a=(0,G.getDrawingPresenceEventKey)(s),d=null==n?void 0:n.instanceId,l=null==n?void 0:n.store,c=(0,W.VK)((()=>Boolean(n&&d&&i&&s&&(0,tt.Z)(a)&&e.canEdit())),[n,s,e,a,d,i]);(0,h.useEffect)((()=>{if(!(c&&n&&d&&i&&l))return;const t=new S,s=et.Z.addListener(a,(function(n,o){!function(t){const{[rt]:e,tldrawStore:n,maybePresenceData:o,[ot]:r,intl:i}=t;let s;try{s=(0,Y.XS)(lt,o)}catch(l){return}const a=new _;for(const[c,u]of(0,b.objectEntries)(s))c!==e.userId&&u&&a.mergeSnapshot(u);if(a.ignore(...r.getPendingIds()),!a.hasChanges())return;const d=Object.values(a.added);for(const c of d)if(q.Anc.isInstance(c)){const{userId:t}=c,n=t.split(":",2)[1];if(n&&(0,k.isUUIDWithDashes)(n)){const o=nt.t1.createChildStore(e,{table:J.KJ,id:n}).getDisplayName(i);a.add(q.bKH.create({id:t,name:o}))}}n.mergeRemoteChanges((()=>{n.put(Object.values(a.added)),n.remove(Array.from(a.removed))}))}({[rt]:e,tldrawStore:l,maybePresenceData:o,[ot]:t,intl:r})}),d,o),u=p().throttle((()=>{const n=t.clear();!function(t){const{environment:e,[rt]:n,diff:o}=t,{userId:r}=n;if(!r)return;const i=(0,G.getDrawingPresenceEventKey)(n.id),s={};let a=!1;for(const[d,[,l]]of y(o))if(pt(d)){a=!0;const t=l?v.serialize(l):0;s[d]=t}if(!a)return;et.Z.updateField(i,r,s,it,e)}({environment:o,[rt]:e,diff:n})}),st),h=l.listen((function(e){let{changes:n,source:o}=e;"user"===o&&(t.add(n),u())}));return et.Z.onDisconnect(a,[{operation:"setField",key:a,field:i,value:0,ttl:it}],d,o),()=>{h(),s&&et.Z.removeListener(s,o),et.Z.setField(a,i,0,it,o),et.Z.clearOnDisconnect(a,d,o)}}),[c,e.id,a,d,o,e,r,n,i,l])}const ut=[q.Anc,q.wwX,q.KjH];function pt(t){return ut.some((e=>e.isId(t)))}const ht=n(85).LCr,gt=n(85).sbn,mt=n(85).L6j,ft=n(85).dL6,bt=n(85).o8N,wt=n(85).Kiu,vt=n(85).i5q,yt=n(85).D7I,_t=n(85).rGB,St=n(85).VXW,xt=n(85).TtP,kt=2*I.SecondMs,It=l.bKH.createId(),Mt=(0,a.F)({format:t=>t}),zt=(0,f.exposeDebugValue)("drawings",{});function Et(){for(var t=arguments[xt],e=new Array(t),n=0;n<t;n++)e[n]=arguments[n]}function Ct(){for(var t=arguments[xt],e=new Array(t),n=0;n<t;n++)e[n]=arguments[n]}function Ft(t){window.__c={n:"TldrawAdapter"};const{store:e}=t,n="dark"===(0,m.Fg)().mode,[o,i]=(0,h.useState)(void 0),a=(0,h.useCallback)((t=>{i(t)}),[]);(0,h.useEffect)((()=>{o&&(t.disabled?o.enableReadOnlyMode():o.updateUserDocumentSettings({isReadOnly:!1}))}),[o,t.disabled]);const d=(0,h.useRef)();(0,h.useEffect)((()=>{var e,n;t.isEditing?(null==o||o.focus(),null==o||o.updateInstanceState({isFocusMode:(null===(e=d.current)||void 0===e?void 0:e.isFocusMode)??!1}),null==o||o.setSelectedIds((null===(n=d.current)||void 0===n?void 0:n.shapeIds)??[])):o&&(d.current={shapeIds:o.selectedIds,isFocusMode:o.instanceState.isFocusMode},o.blur(),o.updateInstanceState({isFocusMode:!0}),o.setSelectedTool("hand"),o.selectNone())}),[o,t.isEditing]),(0,h.useEffect)((()=>{o&&requestAnimationFrame((()=>{Pt.call(o,{inset:0,include:[o.viewportPageBounds]})}))}),[o]);const u=(0,h.useCallback)((t=>{throw z.showErrorMessage(s()(M.FormattedMessage,{id:"drawing.images-not-supported",defaultMessage:"Images are not supported in drawings yet"})),new Error("Image assets are not supported yet.")}),[]),f=l.WqU.default,{syncedStore:w,[St]:_,instanceId:k}=function(t){let{store:e,config:n}=t;const o=(0,g.O7)(),[r]=(0,h.useState)((()=>jt)),i=(0,h.useMemo)((()=>{const t=e[St];return t?l.bKH.createCustomId(t):It}),[e[St]]),s=(0,h.useMemo)((()=>{const t=`tab/${r}/store/${e.key}`;return l.KjH.createCustomId(t)}),[r,e.key]),[a,d]=(0,h.useState)(null);(0,h.useEffect)((()=>{const t=`block/${e.id}/store/${e.key}/effect/${Kt++}`;d({id:t,syncedStore:{status:"loading"}});const r=e=>{d((n=>(null==n?void 0:n.id)===t?{id:t,syncedStore:e}:n))},a=n.createStore({[St]:i,instanceId:s}),l=t=>{const e=(0,c.$F)(a[wt].serialize(),t);if(0===e)return;const n=new Error(e<0?"This drawing is from a newer version of Notion. Update Notion to edit it.":"This drawing is from an older version of Notion. Reload to edit it.");throw Et("schema mismatch",{[bt]:n,incomingSchema:t,ourSchema:a[wt].serialize()}),r({status:bt,[bt]:n}),n},u=e.getDrawingStore(),h=e[ft]("version"),g={drawingStore:u,schemaStore:u[ft](wt),snapshotStore:u[ft](mt),typeStore:u[ft]("type"),getLastVersion:()=>h.isReady()?h[gt]()??-1:-1};let m=!1;const f=new S,w=()=>{if(m)return void Et("skip update: ignoreNotionUpdates");const t=g.drawingStore[gt]();t?(t[wt]&&l(t[wt]),a.mergeRemoteChanges((()=>{const e=f.getPendingIds(),n=[],o=[];for(const[r,i]of(0,b.objectEntries)(t[mt]||{}))e.has(r)?Et("skip record: ahead:",{id:r}):i?o.push(v.deserialize(i)):n.push(r);Et("apply updates",{removedIds:n,updatedRecords:o,pendingDiffIds:e}),a.remove(n),a.put(o)}))):Et("skip update: no Notion drawingValue")},_=function(){let t=arguments[xt]>0&&void 0!==arguments[0]&&arguments[0];const n=f.clear(),i=g.getLastVersion();C.createAndCommit({environment:o,userAction:"drawing.persist",[St]:e[St],perform(e){try{m=!0,Ct("begin persist",{squashed:n,initialVersion:i});const o=u[gt]();if(o&&"tldraw"!==o.type){const t=Error(`Unknown drawing value type: ${o.type}`);throw r({status:bt,[bt]:t}),t}if(g.typeStore.isReady()&&!g.typeStore[gt]()){const t="tldraw";Ct("persist type:",t),E.setValue({store:g.drawingStore,value:{type:t},[ht]:e})}const s=g.schemaStore[gt](),d=t||g.schemaStore.isReady()&&!s;if(d){const t=a[wt].serialize();Ct("persist schema:",t),E.setValue({value:t,store:g.schemaStore,[ht]:e})}s&&!t&&l(s);let c={},p=!1;const h=d||g.snapshotStore.isReady()&&!g.snapshotStore[gt]();h&&(p=!0,c=Object.fromEntries(Object.entries(a.serialize()).filter((t=>{let[e]=t;return Dt(e)})).map((t=>{let[e,n]=t;return[e,v.serialize(n)]}))));for(const[t,[,e]]of y(n))Dt(t)&&(p=!0,c[t]=e?v.serialize(e):0);p&&(Ct("persist snapshot update:",c,h),E.updateValue({store:g.snapshotStore,[ht]:e,data:c}))}finally{m=!1,Ct("end persist",{initialVersion:i,finalVersion:g.getLastVersion()})}}})},k=p().throttle(_,kt),I=t=>{let{changes:e,source:n}=t;Ct("changes:",n,e),"user"===n&&(f.add(e),k())};let M=!1;(async()=>{try{if(await u.load(),M)return;const t=u[gt]();if(t){const e={};for(const[r,i]of(0,b.objectEntries)(t[mt]||{}))i&&(e[r]=v.deserialize(i));const n=t[wt]?(0,c.$F)(t[wt],a[wt].serialize()):0,o=a[wt].migrateStoreSnapshot(e,t[wt]??a[wt].serializeEarliestVersion());if("error"===o.type)throw Et("migration error:",o),new Error(`This version of Notion isn't compatible with this drawing (${o.reason})`);a.mergeRemoteChanges((()=>{a.put(Object.values(e),vt)})),0!==n&&_(!0)}u.addListener(w),r({status:"synced",store:a})}catch(t){throw r({status:bt,[bt]:(0,x.tg)(t)}),t}})();const z=a.listen(I);return()=>{M=!0,d((e=>(null==e?void 0:e.id)===t?null:e)),u.removeListener(w),z()}}),[s,n,i,e,o]);const u=(null==a?void 0:a.syncedStore)??{status:"loading"};return{[St]:i,instanceId:s,syncedStore:u}}({store:e,config:f});ct({blockStore:e,app:o}),(0,h.useEffect)((()=>{if(o)return zt[k]=o,()=>{delete zt[k]}}),[k,o]);const I=(0,h.useMemo)((()=>{let t=null;return[{helpMenu(e,n,o){const r=n.find((t=>"top"===t.id));return t=(0,l.$5f)("help",...r[_t]),[]}},{menu(e,n,o){n.push(t);for(const{item:t,parent:r,index:i}of function*(t){const e=[];function*n(t){for(let o=0;o<t[xt];o++){const r=t[o];yield{index:o,item:r,path:e,parent:e.at(-1)},"group"!==r.type&&"submenu"!==r.type||(e.push(r),yield*n(r[_t]),e.pop())}}yield*n(t)}(n))"toggle-dark-mode"===t.id&&r&&r[_t].splice(i,1),"LANGUAGE_MENU"===t.id&&r&&r[_t].splice(i,1),"insert-media"===t.id&&r&&r[_t].splice(i,1);return n},toolbar:(t,e,n)=>e.filter((t=>"asset"!==t.id)),actions(t,e,n){const o=e["toggle-dark-mode"];return o&&(o.kbd=void 0),e}}]}),[]),F={isDarkMode:n,config:f,assetUrls:Mt,overrides:I};return h[yt](h.Fragment,null,s()(X,{}),h[yt](l.gRN,r()({onMount:a,instanceId:k,[St]:_,store:w},F,{onCreateAssetFromFile:u}),h[yt](l.p4C,F,s()(l.xVl,{},void 0,s()(l.Xz7,{})))))}const jt=(0,k.default)();let Kt=0;function Dt(t){return![l.F7R,l.iHI,l.bKH,l.Anc,l.luK,l.KjH,l.wwX].some((e=>e.isId(t)))}function Pt(t){if(!this.canMoveCamera)return this;const e=[...this.shapeIds];if(e[xt]<=0)return this;const n=(0,u.compact)(e.map((t=>this.getPageBoundsById(t))));null!=t&&t.include&&n.push(...t.include);const o=d.No.Common(n);return Nt.call(this,o.minX,o.minY,o.width,o.height,void 0,t),this}function Nt(t,e,n,o,r,i){if(!this.canMoveCamera)return this;const{viewportScreenBounds:s}=this,a=(null==i?void 0:i.inset)??Math.min(256,.28*s.width);let l=(0,d.uZ)(Math.min((s.width-a)/n,(s.height-a)/o),.1,8);return void 0!==r&&(l=Math.min(r,l)),null!=i&&i.duration?this.animateCamera(-t+(s.width-n*l)/2/l,-e+(s.height-o*l)/2/l,l,i):this.setCamera(-t+(s.width-n*l)/2/l,-e+(s.height-o*l)/2/l,l),this}}}]);